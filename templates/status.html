{% extends "base.html" %}
{% block title %}ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ - åŒ—æµ·é“ãƒ•ã‚§ãƒªãƒ¼äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ {% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h2>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h2>
        <p class="text-muted">ãƒ‡ãƒ¼ã‚¿è“„ç©çŠ¶æ³ã¨äºˆæ¸¬ç²¾åº¦ã®ç¢ºèª</p>
    </div>
</div>

<div id="loading" class="text-center">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã‚’å–å¾—ä¸­...</p>
</div>

<div id="status-container">
    <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
</div>

<script>
function loadStatus() {
    document.getElementById('loading').style.display = 'block';
    
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                displayStatus(data);
            } else {
                document.getElementById('status-container').innerHTML = 
                    '<div class="alert alert-danger">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status-container').innerHTML = 
                '<div class="alert alert-danger">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
        });
}

function displayStatus(data) {
    const container = document.getElementById('status-container');
    
    const progress = (data.data_status.current_count / data.data_status.max_count) * 100;
    
    let html = `
        <!-- ãƒ‡ãƒ¼ã‚¿åé›†çŠ¶æ³ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿åé›†çŠ¶æ³</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>åé›†ãƒ‡ãƒ¼ã‚¿æ•°:</strong> ${data.data_status.current_count}ä»¶ / ${data.data_status.max_count}ä»¶</p>
                        <div class="progress mb-3">
                            <div class="progress-bar" style="width: ${progress}%">${progress.toFixed(1)}%</div>
                        </div>
                        <p><strong>çŠ¶æ…‹:</strong> <span class="badge bg-${getStatusBadgeColor(data.data_status.status)}">${data.data_status.message}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>æœ€çµ‚æ›´æ–°:</strong> ${new Date(data.data_status.last_updated).toLocaleString('ja-JP')}</p>
                        <p><strong>è‡ªå‹•åœæ­¢:</strong> ${data.data_status.auto_stop_enabled ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">ğŸ¤– äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>äºˆæ¸¬æ®µéš:</strong> ${data.prediction_params.stage}</p>
                        <p><strong>äºˆæ¸¬æ‰‹æ³•:</strong> ${data.prediction_params.prediction_method}</p>
                        <p><strong>ä¿¡é ¼åº¦:</strong> ${Math.round(data.prediction_params.confidence_base * 100)}%</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>æ®µéšé€²æ—:</strong> ${Math.round(data.prediction_params.progress * 100)}%</p>
                        <p><strong>é©å¿œèª¿æ•´å›æ•°:</strong> ${data.prediction_params.adaptation_count}å›</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // é©å¿œãƒ¬ãƒãƒ¼ãƒˆ
    if (data.adaptation_report && !data.adaptation_report.error) {
        html += `
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">âš™ï¸ é©å¿œã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒãƒ¼ãƒˆ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ã‚·ã‚¹ãƒ†ãƒ æˆç†Ÿåº¦:</strong> ${data.adaptation_report.system_maturity}</p>
                            <p><strong>ä¿¡é ¼åº¦ãƒ¬ãƒ™ãƒ«:</strong> ${data.adaptation_report.confidence_level}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>æ®µéšé€²æ—:</strong> ${data.adaptation_report.stage_progress}</p>
                        </div>
                    </div>
                    
                    ${data.adaptation_report.recommendations ? `
                    <h6>ğŸ“‹ æ¨å¥¨äº‹é …</h6>
                    <ul>
                        ${data.adaptation_report.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                    ` : ''}
                    
                    ${data.adaptation_report.threshold_changes && data.adaptation_report.threshold_changes.length > 0 ? `
                    <h6>ğŸ”§ é–¾å€¤èª¿æ•´å±¥æ­´</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>æ¡ä»¶</th>
                                    <th>ãƒ¬ãƒ™ãƒ«</th>
                                    <th>å¤‰æ›´ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.adaptation_report.threshold_changes.slice(0, 5).map(change => `
                                <tr>
                                    <td>${change.condition}</td>
                                    <td>${change.level}</td>
                                    <td>${change.change_percent > 0 ? '+' : ''}${change.change_percent.toFixed(1)}%</td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function getStatusBadgeColor(status) {
    const colors = {
        'COMPLETED': 'success',
        'NEAR_COMPLETION': 'warning',
        'LEARNING_ACTIVE': 'info',
        'COLLECTING': 'primary',
        'NOT_STARTED': 'secondary'
    };
    return colors[status] || 'secondary';
}

// åˆå›èª­ã¿è¾¼ã¿
loadStatus();

// 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
setInterval(loadStatus, 30000);
</script>
{% endblock %}