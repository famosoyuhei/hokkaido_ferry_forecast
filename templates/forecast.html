{% extends "base.html" %}
{% block title %}7æ—¥é–“é‹èˆªäºˆå ± - åŒ—æµ·é“ãƒ•ã‚§ãƒªãƒ¼äºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ {% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2>ğŸš¢ 7æ—¥é–“é‹èˆªäºˆå ±</h2>
                <p class="text-muted mb-0">ãƒãƒ¼ãƒˆãƒ©ãƒ³ãƒ‰ãƒ•ã‚§ãƒªãƒ¼ åˆ©å°»ãƒ»ç¤¼æ–‡èˆªè·¯ (æ¯æ—¥18ä¾¿)</p>
            </div>
            <div>
                <button class="btn btn-success" onclick="loadForecast()" id="refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> æ›´æ–°
                </button>
                <small class="text-muted d-block mt-1" id="last-update">æœ€çµ‚æ›´æ–°: --:--</small>
            </div>
        </div>
    </div>
</div>

<!-- æ—¥ä»˜ã‚¿ãƒ– -->
<div class="row mb-4">
    <div class="col-12">
        <nav>
            <div class="nav nav-tabs" id="date-tabs" role="tablist">
                <!-- æ—¥ä»˜ã‚¿ãƒ–ãŒã“ã“ã«å‹•çš„ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
        </nav>
    </div>
</div>

<!-- äºˆå ±æ¦‚è¦ -->
<div id="forecast-summary" class="row mb-3" style="display:none;">
    <div class="col-md-3">
        <div class="card bg-light">
            <div class="card-body text-center">
                <h6 class="card-title">ç·ä¾¿æ•°</h6>
                <h4 id="total-services" class="text-primary">--</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success bg-opacity-10">
            <div class="card-body text-center">
                <h6 class="card-title">æ­£å¸¸é‹èˆªäºˆå®š</h6>
                <h4 id="normal-services" class="text-success">--</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning bg-opacity-10">
            <div class="card-body text-center">
                <h6 class="card-title">è¦æ³¨æ„ä¾¿</h6>
                <h4 id="warning-services" class="text-warning">--</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger bg-opacity-10">
            <div class="card-body text-center">
                <h6 class="card-title">âš ï¸ æ¬ èˆªãƒªã‚¹ã‚¯</h6>
                <h4 id="high-risk-services" class="text-danger">--</h4>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="text-center">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <p class="mt-2">7æ—¥é–“ã®é‹èˆªäºˆå ±ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>
</div>

<div id="forecast-container">
    <div class="tab-content" id="date-content">
        <!-- å„æ—¥ã®äºˆå ±ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
    </div>
</div>

<script>
let forecastData = {};
let currentDate = null;
let autoRefreshInterval = null;

function loadForecast() {
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    document.getElementById('loading').style.display = 'block';
    document.getElementById('forecast-summary').style.display = 'none';
    document.getElementById('forecast-container').innerHTML = '';
    
    // æ›´æ–°ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
    document.getElementById('refresh-btn').disabled = true;
    
    fetch('/api/7day_forecast')
        .then(response => response.json())
        .then(data => {
            forecastData = data.forecast_data || {};
            
            // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
            updateSummaryStats();
            
            // æ—¥ä»˜ã‚¿ãƒ–ä½œæˆ
            createDateTabs();
            
            // æœ€åˆã®æ—¥ã‚’è¡¨ç¤º
            const dates = Object.keys(forecastData).sort();
            if (dates.length > 0) {
                showDateForecast(dates[0]);
                currentDate = dates[0];
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
            document.getElementById('loading').style.display = 'none';
            document.getElementById('forecast-summary').style.display = 'block';
            document.getElementById('forecast-container').style.display = 'block';
            
            // æ›´æ–°æ™‚åˆ»è¡¨ç¤º
            updateLastUpdateTime();
        })
        .catch(error => {
            console.error('Error loading forecast:', error);
            document.getElementById('loading').innerHTML = 
                '<div class="alert alert-danger">äºˆå ±ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        })
        .finally(() => {
            document.getElementById('refresh-btn').disabled = false;
        });
}

function updateSummaryStats() {
    let totalServices = 0;
    let warningServices = 0;
    let highRiskServices = 0;
    
    for (const date in forecastData) {
        const dayData = forecastData[date];
        totalServices += dayData.services.length;
        
        dayData.services.forEach(service => {
            const riskLevel = service.risk.risk_level;
            if (riskLevel === 'High' || riskLevel === 'Critical') {
                highRiskServices++;
            } else if (riskLevel === 'Medium') {
                warningServices++;
            }
        });
    }
    
    document.getElementById('total-services').textContent = totalServices;
    document.getElementById('warning-services').textContent = warningServices;
    document.getElementById('high-risk-services').textContent = highRiskServices;
}

function createDateTabs() {
    const dates = Object.keys(forecastData).sort();
    let tabsHtml = '<ul class="nav nav-tabs mb-3" id="date-tabs">';
    
    dates.forEach((date, index) => {
        const dayData = forecastData[date];
        const activeClass = index === 0 ? 'active' : '';
        
        tabsHtml += `
            <li class="nav-item">
                <button class="nav-link ${activeClass}" onclick="showDateForecast('${date}')" 
                        data-date="${date}">
                    ${dayData.date_display}
                    <br>
                    <small class="text-muted">${dayData.weekday}æ›œæ—¥</small>
                </button>
            </li>
        `;
    });
    
    tabsHtml += '</ul>';
    document.getElementById('forecast-container').innerHTML = tabsHtml + '<div id="date-content"></div>';
}

function showDateForecast(date) {
    currentDate = date;
    
    // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('#date-tabs .nav-link').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.date === date) {
            tab.classList.add('active');
        }
    });
    
    const dayData = forecastData[date];
    if (!dayData) return;
    
    let servicesHtml = '<div class="row g-3">';
    
    dayData.services.forEach(service => {
        const risk = service.risk;
        const weather = service.weather;
        const riskScore = Math.round(risk.risk_score);
        
        let cardClass = 'border-success';
        let badgeClass = 'bg-success';
        let riskIcon = 'âœ“';
        let alertBanner = '';
        
        if (risk.risk_level === 'Critical') {
            cardClass = 'border-danger';
            badgeClass = 'bg-danger';
            riskIcon = 'ğŸš«';
            alertBanner = `
                <div class="alert alert-danger mb-2 py-2" role="alert">
                    <strong>âš ï¸ æ¬ èˆªãƒªã‚¹ã‚¯æ¥µé«˜ (${riskScore}%)</strong>
                </div>
            `;
        } else if (risk.risk_level === 'High') {
            cardClass = 'border-warning';
            badgeClass = 'bg-warning';
            riskIcon = 'âš ï¸';
            alertBanner = `
                <div class="alert alert-warning mb-2 py-2" role="alert">
                    <strong>âš ï¸ æ¬ èˆªãƒªã‚¹ã‚¯é«˜ (${riskScore}%)</strong>
                </div>
            `;
        } else if (risk.risk_level === 'Medium') {
            cardClass = 'border-info';
            badgeClass = 'bg-info';
            riskIcon = 'âš¡';
        }
        
        const riskFactorsText = risk.risk_factors.length > 0 
            ? risk.risk_factors.join(', ') 
            : 'è‰¯å¥½';
            
        servicesHtml += `
            <div class="col-md-6 col-lg-4">
                <div class="card ${cardClass} h-100">
                    ${alertBanner}
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>${service.route_name}</strong>
                        <span class="badge ${badgeClass}">${riskIcon} ${risk.risk_level}</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6">
                                <small class="text-muted">å‡ºèˆª</small><br>
                                <strong>${service.departure_time}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">åˆ°ç€</small><br>
                                <strong>${service.arrival_time}</strong>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="small">
                            <div class="d-flex justify-content-between">
                                <span>æ¬ èˆªãƒªã‚¹ã‚¯:</span>
                                <span class="fw-bold">${riskScore}%</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>é¢¨é€Ÿ:</span>
                                <span>${weather.wind_speed}m/s</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>æ³¢é«˜:</span>
                                <span>${weather.wave_height}m</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>è¦–ç•Œ:</span>
                                <span>${weather.visibility}km</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>æ°—æ¸©:</span>
                                <span>${weather.temperature}Â°C</span>
                            </div>
                            ${risk.risk_factors.length > 0 ? 
                                `<div class="mt-2"><small class="text-warning">âš ï¸ ${riskFactorsText}</small></div>` 
                                : ''
                            }
                        </div>
                    </div>
                    <div class="card-footer small text-muted">
                        ${service.vessel} | ä¾¿${service.service_no}
                    </div>
                </div>
            </div>
        `;
    });
    
    servicesHtml += '</div>';
    document.getElementById('date-content').innerHTML = servicesHtml;
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ja-JP', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('last-update').textContent = timeString;
}

// è‡ªå‹•æ›´æ–°è¨­å®š
function setupAutoRefresh() {
    // 5åˆ†é–“éš”ã§è‡ªå‹•æ›´æ–°
    autoRefreshInterval = setInterval(() => {
        loadForecast();
    }, 5 * 60 * 1000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// æ‰‹å‹•æ›´æ–°
function refreshForecast() {
    loadForecast();
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadForecast();
    setupAutoRefresh();
});

// ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã®å‡¦ç†
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});
</script>
</body>
</html>
'''
loadForecast(3);
</script>

<style>
.bg-orange {
    background-color: #fd7e14 !important;
}
</style>
{% endblock %}