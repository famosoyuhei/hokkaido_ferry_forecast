# 気象予報データソース分析レポート
**分析日**: 2025年10月22日

## 📋 質問への回答

### Q1: 風速や視界などの気象要素の未来の予報はどこから取得していますか？

**A: 現在は取得していません - 重大な問題が発見されました！**

---

## 🚨 現状の問題点

### 現在のシステム構成

```
┌──────────────────────────────────────────┐
│ improved_ferry_collector.py              │
│                                          │
│ ✅ 現在値のみ収集:                        │
│   - Open-Meteo API                       │
│   - リアルタイムデータのみ                │
│   - 予報データなし                        │
│                                          │
│ 取得データ:                              │
│   - 気温（current）                       │
│   - 風速（current）                       │
│   - 視界（current）                       │
│   - 風向（current）                       │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│ generate_forecast_data.py                │
│                                          │
│ ❌ シミュレーションデータのみ:            │
│   - ランダム生成                         │
│   - 実際の予報なし                        │
│   - デモ用のみ                           │
└──────────────────────────────────────────┘
```

### 重要な発見

**予報データが一切取得されていない！**
- 現在のシステムは「現在値」のみを収集
- 「将来の予報」は生成していない
- 7day_forecast.jsonはシミュレーションデータ（2025年8月31日生成、古いデータ）

---

## 💡 昆布干場アプリからのインスピレーション

### Q2: 昆布干場予報アプリのデータを拡張する方法は有効ですか？

**A: 非常に有効です！JMA（気象庁）APIを使用する戦略を推奨します**

### 理由

1. **同じ気象庁データソース**
   - 昆布干場アプリも気象庁データを使用している可能性が高い
   - 公式データで信頼性が高い
   - 無料でアクセス可能

2. **地域特化データ**
   - 稚内、利尻、礼文の詳細予報が利用可能
   - 海上予報（波高、風速）を含む
   - 時間単位の予報（最大7日間）

3. **フェリー運航に必要な全データ**
   ✅ 風速・風向
   ✅ 波高
   ✅ 気温
   ✅ 降水確率
   ✅ 天気概況
   ⚠️ 視界（直接は含まれないが、天気コードから推定可能）

---

## 📊 利用可能な気象データAPI比較

### 1. JMA（気象庁）API - 🏆 推奨

```
エンドポイント:
https://www.jma.go.jp/bosai/forecast/data/forecast/{area_code}.json

対象地域:
- 稚内: 011000（宗谷地方全体）
- 利尻・礼文: 011013（北部宗谷）

提供データ:
✅ 風速・風向（テキスト形式）
✅ 波高（メートル）
✅ 気温（時間別、日別最高/最低）
✅ 降水確率（6時間ごと）
✅ 天気概況
✅ 信頼度（A/B/C）

予報期間:
- 短期: 36時間（6時間刻み）
- 週間: 7日間（日別）

更新頻度:
- 1日5回（05:00, 11:00, 17:00など）

コスト: 無料
制限: 非公式API（変更の可能性あり）
精度: ⭐⭐⭐⭐⭐（気象庁公式）
```

**サンプルデータ（2025-10-22 05:00）:**
```json
{
  "風": "北西の風 やや強く",
  "波": "1.5 メートル",
  "気温": {
    "時間": ["8°C", "3°C", ...],
    "最高": "8°C",
    "最低": "3°C"
  },
  "降水確率": ["10%", "10%", "20%", "50%"],
  "天気": "くもり 時々 雨か雪",
  "信頼度": "A"
}
```

### 2. Open-Meteo API - ⭐ 現在使用中（現在値のみ）

```
エンドポイント:
https://api.open-meteo.com/v1/forecast

提供データ:
✅ 風速（数値）
✅ 風向（度）
✅ 気温
✅ 視界
❌ 波高（利用不可）
✅ 予報データ（最大16日）

予報期間:
- 最大16日間
- 時間単位

更新頻度:
- リアルタイム

コスト: 無料
制限: 10,000リクエスト/日
精度: ⭐⭐⭐⭐（気象モデルベース）
```

### 3. 日本気象協会（tenki.jp）- 商用

```
コスト: 有料
精度: ⭐⭐⭐⭐⭐
制限: 契約必要
```

---

## 🎯 推奨される統合戦略

### フェーズ1: JMA + Open-Meteo ハイブリッド（推奨）

**データソースの役割分担:**

```
┌─────────────────────────────────────┐
│ JMA API（気象庁）                   │
│ - 主要データソース                   │
│ - 風速・風向（テキスト → 数値変換） │
│ - 波高（重要！）                     │
│ - 天気概況                          │
│ - 信頼度情報                         │
│ - 7日間予報                         │
└─────────────────────────────────────┘
          ↓ 統合
┌─────────────────────────────────────┐
│ Open-Meteo API                      │
│ - 補完データソース                   │
│ - 視界（JMAにない）                  │
│ - 詳細な時間別データ                │
│ - バックアップ                       │
└─────────────────────────────────────┘
          ↓
┌─────────────────────────────────────┐
│ 統合予報データベース                │
│ - 風速（数値、m/s）                  │
│ - 波高（メートル）                   │
│ - 視界（km）                         │
│ - 気温（°C）                         │
│ - 信頼度                            │
│ - 7日間先まで                       │
└─────────────────────────────────────┘
```

### 実装の優先順位

**即時実装（今週）:**
1. ✅ JMA API統合
   - 稚内エリア（011000）の予報取得
   - 風速・波高・気温の解析
   - データベースへの保存

2. ✅ 風速テキストの数値化
   ```python
   風の表現 → 数値変換:
   "やや強く" → 15-20 m/s
   "強く" → 20-25 m/s
   "非常に強く" → 25+ m/s
   ```

3. ✅ 7日間予報の生成
   - 毎日朝5時にJMAデータ取得
   - 欠航リスク計算
   - ユーザーへの通知

**中期実装（来月）:**
1. Open-Meteo予報データの追加
   - 視界予報の取得
   - 時間単位の詳細予報

2. 予報精度の検証
   - JMA予報 vs 実績
   - モデルの調整

**長期実装（3ヶ月後）:**
1. アンサンブル予報
   - 複数モデルの統合
   - 不確実性の定量化

---

## 🔧 実装設計

### 新しいコレクター: `forecast_collector.py`

```python
class WeatherForecastCollector:
    """統合気象予報コレクター"""

    def __init__(self):
        # JMA API設定
        self.jma_area_codes = {
            'wakkanai_soya': '011000',  # 宗谷地方
            'north_soya': '011013'       # 利尻・礼文
        }

        # Open-Meteo設定
        self.locations = {
            'wakkanai': (45.415, 141.673),
            'rishiri': (45.180, 141.240),
            'rebun': (45.300, 141.040)
        }

    def collect_jma_forecast(self, area_code='011000'):
        """JMA 7日間予報取得"""
        url = f"https://www.jma.go.jp/bosai/forecast/data/forecast/{area_code}.json"

        # 予報データ取得
        # 風速・波高・気温の解析
        # データベース保存

    def collect_openmeteo_forecast(self, location):
        """Open-Meteo 予報取得（視界補完用）"""
        url = "https://api.open-meteo.com/v1/forecast"
        params = {
            'latitude': location[0],
            'longitude': location[1],
            'hourly': ['visibility', 'temperature_2m',
                      'windspeed_10m', 'winddirection_10m'],
            'forecast_days': 7
        }

    def integrate_forecasts(self):
        """JMA + Open-Meteo データ統合"""
        # JMAの波高・風速をベースに
        # Open-Meteoの視界を追加
        # 統合データベースへ保存

    def generate_cancellation_forecast(self):
        """7日間欠航リスク予報"""
        # 統合データから欠航リスク計算
        # 高リスク日の特定
        # 通知生成
```

### データベーススキーマ

```sql
CREATE TABLE weather_forecast (
    id INTEGER PRIMARY KEY,
    forecast_date DATE,
    forecast_hour INTEGER,
    location TEXT,  -- 'wakkanai', 'rishiri', 'rebun'

    -- JMA データ
    wind_speed_text TEXT,
    wind_speed_estimate REAL,  -- m/s
    wave_height REAL,           -- meters
    weather_code TEXT,
    reliability TEXT,           -- 'A', 'B', 'C'

    -- Open-Meteo データ
    visibility REAL,            -- km
    temperature REAL,           -- °C

    -- 統合データ
    cancellation_risk TEXT,     -- 'LOW', 'MEDIUM', 'HIGH'
    risk_score REAL,            -- 0-100

    -- メタデータ
    jma_issued_at TIMESTAMP,
    collected_at TIMESTAMP,
    forecast_horizon INTEGER    -- hours ahead
);

CREATE TABLE cancellation_forecast (
    id INTEGER PRIMARY KEY,
    forecast_for_date DATE,
    route TEXT,
    departure_time TEXT,

    risk_level TEXT,
    risk_score REAL,
    risk_factors JSON,

    wind_forecast REAL,
    wave_forecast REAL,
    visibility_forecast REAL,

    recommended_action TEXT,
    confidence REAL,

    generated_at TIMESTAMP
);
```

---

## 📈 期待される改善効果

### 現在 vs 改善後

| 項目 | 現在 | 改善後 | 効果 |
|------|------|--------|------|
| 予報期間 | 0日（現在値のみ） | 7日間 | +700% |
| 波高データ | なし | あり | +100% |
| 風速データ | 現在値のみ | 7日間予報 | +700% |
| 視界データ | 現在値のみ | 7日間予報 | +700% |
| 信頼度情報 | なし | JMA信頼度 | +100% |
| 更新頻度 | 1日1回 | 1日5回 | +400% |
| データソース | 1つ | 2つ（冗長性） | リスク軽減 |

### ユーザーへの価値

**Before（現在）:**
```
❌ 欠航予測不可能
❌ 当日の状況のみ確認可能
❌ 旅行計画が立てられない
```

**After（改善後）:**
```
✅ 7日先まで欠航リスク予測
✅ 高リスク日を事前に回避
✅ 旅行計画の最適化
✅ 代替便の検討時間確保
✅ 信頼度付き予報
```

---

## 🎯 実装ロードマップ

### Week 1: 基本統合
```
Day 1-2: JMA APIクライアント実装
Day 3-4: 風速テキスト解析ロジック
Day 5: データベーススキーマ作成
Day 6-7: テスト・デバッグ
```

### Week 2: 予報生成
```
Day 1-2: Open-Meteo予報データ統合
Day 3-4: 欠航リスク予測ロジック
Day 5: 7日間予報UI実装
Day 6-7: 精度検証
```

### Week 3: 運用開始
```
Day 1-2: Railway cron設定
Day 3-4: 通知システム統合
Day 5: ドキュメント整備
Day 6-7: モニタリング
```

---

## 💰 コスト分析

### 現在のコスト
```
Open-Meteo API: $0/月（無料枠）
Total: $0/月
```

### 改善後のコスト
```
JMA API: $0/月（無料、公式データ）
Open-Meteo API: $0/月（無料枠）
Total: $0/月
```

**追加コストなしで大幅な機能向上！** 🎉

---

## ⚠️ リスクと対策

### リスク1: JMA API変更
```
確率: 中
影響: 大
対策:
- Open-Meteoバックアップ
- 定期的なAPI監視
- エラーハンドリング強化
```

### リスク2: データ解析精度
```
確率: 中
影響: 中
対策:
- JMA風速テキストの詳細マッピング
- 実績データとの継続的比較
- アルゴリズムの調整
```

### リスク3: 予報精度の限界
```
確率: 高
影響: 中
対策:
- 信頼度情報の明示
- 不確実性の可視化
- 複数シナリオの提示
```

---

## 📊 成功指標（KPI）

### 技術的KPI
1. **予報データ取得率**: >95%
2. **予報精度**: 風速誤差 <3 m/s
3. **更新遅延**: <30分
4. **システム稼働率**: >99%

### ビジネスKPI
1. **予報リードタイム**: 7日間
2. **高リスク検出率**: >90%
3. **誤報率**: <20%
4. **ユーザー満足度**: 目標設定後測定

---

## ✅ 結論と推奨事項

### 回答まとめ

**Q1: 現在の予報データソースは？**
→ A: なし（現在値のみ）- **早急な改善が必要**

**Q2: 昆布干場アプリの手法は有効？**
→ A: **非常に有効** - JMA APIの使用を強く推奨

### 即座に実装すべき改善

1. **JMA API統合** 🏆
   - 優先度: 最高
   - 期間: 1週間
   - 効果: 予報期間 0日 → 7日

2. **Open-Meteo予報拡張**
   - 優先度: 高
   - 期間: 3日
   - 効果: 視界予報追加

3. **統合予報システム**
   - 優先度: 高
   - 期間: 2週間
   - 効果: 欠航予測精度向上

### 期待される成果

```
現在: 事後対応型（欠航後に確認）
    ↓
改善後: 予測型（7日前から計画可能）

精度向上: 0% → 75-85%（推定）
ユーザー価値: 低 → 非常に高
```

---

**レポート作成**: Claude Code
**分析日**: 2025年10月22日
**ステータス**: ⚠️ **緊急改善推奨**
**次のアクション**: JMA API統合実装
