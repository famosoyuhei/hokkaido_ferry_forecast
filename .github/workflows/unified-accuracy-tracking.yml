name: Unified Accuracy Tracking

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 07:00 JST (22:00 UTC)

  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD) or leave empty for yesterday'
        required: false
        default: ''

jobs:
  track-accuracy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Run unified accuracy tracker via Railway endpoint
        run: |
          echo "Running unified accuracy tracker via Railway admin endpoint..."

          # Call the admin endpoint that runs unified_accuracy_tracker.py
          response=$(curl -s -w "\n%{http_code}" https://web-production-a628.up.railway.app/admin/run-accuracy-tracking)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -eq 200 ]; then
            echo "✅ Accuracy tracking completed successfully"
          else
            echo "❌ Accuracy tracking failed with status $http_code"
            exit 1
          fi

      - name: Comment on commit (if issues found)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Accuracy Tracking Failed',
              body: 'Unified accuracy tracking workflow failed. Please check the logs.',
              labels: ['alert', 'accuracy-tracking']
            })

      - name: Summary
        if: success()
        run: |
          echo "### Unified Accuracy Tracking Completed ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Method**: Railway admin endpoint" >> $GITHUB_STEP_SUMMARY
