name: Unified Accuracy Tracking

on:
  schedule:
    - cron: '0 22 * * *'  # Daily at 07:00 JST (22:00 UTC)

  workflow_dispatch:
    inputs:
      target_date:
        description: 'Target date (YYYY-MM-DD) or leave empty for yesterday'
        required: false
        default: ''

jobs:
  track-accuracy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run unified accuracy tracker on Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Running unified accuracy tracker directly on Railway..."

          # Install Railway CLI
          npm install -g @railway/cli || curl -fsSL https://railway.app/install.sh | sh

          # Run the script directly on Railway with explicit project and service
          # Project ID: c93898e1-5fe6-4fd7-b81d-33cb31b8addf
          # Service: hokkaido-ferry-forecast
          # Environment: production
          railway run --project c93898e1-5fe6-4fd7-b81d-33cb31b8addf --service hokkaido-ferry-forecast --environment production python unified_accuracy_tracker.py

          echo "✅ Accuracy tracking completed successfully"

      - name: Create accuracy report artifact
        uses: actions/upload-artifact@v4
        with:
          name: accuracy-report-${{ github.run_number }}
          path: accuracy_report.txt
          retention-days: 30

      - name: Comment on commit (if issues found)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Accuracy Tracking Failed',
              body: 'Unified accuracy tracking workflow failed. Please check the logs.',
              labels: ['alert', 'accuracy-tracking']
            })

      - name: Summary
        run: |
          echo "### Unified Accuracy Tracking Completed ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f accuracy_report.txt ]; then
            echo "**Report Preview**:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            head -n 30 accuracy_report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
