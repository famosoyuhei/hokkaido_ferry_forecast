# Windowsタスクスケジューラー設定手順書
**北海道フェリー欠航予報システム - 自動データ収集設定**

## 📋 設定概要

このシステムを自動実行するために、Windowsタスクスケジューラーで以下の2つのタスクを設定します：

1. **定期データ収集タスク** - 30分ごとに実行
2. **常駐監視タスク** - システム起動時に開始（推奨）

## 🛠️ 準備作業

### 1. ファイル確認
以下のファイルが作成されていることを確認：
- `auto_data_collection.bat` - 単発実行用
- `auto_data_collection_daemon.bat` - 常駐実行用

### 2. 実行テスト
まず手動でバッチファイルが正常に動作するか確認：
```cmd
cd C:\Users\ichry\OneDrive\Desktop\hokkaido_ferry_forecast
auto_data_collection.bat
```

## 🔧 タスクスケジューラー設定手順

### Step 1: タスクスケジューラーを開く

1. **Windows + R** キーを押す
2. `taskschd.msc` と入力してEnter
3. 「タスクスケジューラー」が開きます

### Step 2: 基本タスクの作成

#### 方法A: 基本タスクウィザードを使用（初心者向け）

1. 右側の「操作」パネルで **「基本タスクの作成」** をクリック
2. **タスク名**: `Ferry Data Collection`
3. **説明**: `北海道フェリー欠航予報データの自動収集`
4. **「次へ」** をクリック

#### Step 3: トリガー設定

**推奨: 常駐監視タスク**
1. **「コンピューターの起動時」** を選択
2. **「次へ」** をクリック

**または: 定期実行タスク**
1. **「毎日」** を選択
2. 開始日時: 今日の日付
3. 開始時刻: `00:00` (深夜0時)
4. **「次へ」** をクリック

#### Step 4: 操作設定

1. **「プログラムの開始」** を選択
2. **「次へ」** をクリック
3. **プログラム/スクリプト**: 
   ```
   C:\Users\ichry\OneDrive\Desktop\hokkaido_ferry_forecast\auto_data_collection_daemon.bat
   ```
4. **開始**: 
   ```
   C:\Users\ichry\OneDrive\Desktop\hokkaido_ferry_forecast
   ```
5. **「次へ」** → **「完了」**

### Step 5: 詳細設定（重要）

作成されたタスクをダブルクリックして開き、以下を設定：

#### 全般タブ
- ☑️ **「ユーザーがログオンしているかどうかにかかわらず実行する」**
- ☑️ **「最上位の特権で実行する」**
- **構成**: `Windows 10`

#### トリガータブ
**定期実行タスクの場合のみ**：
1. トリガーをダブルクリック
2. ☑️ **「繰り返し間隔」**: `30分間`
3. **継続時間**: `無期限`

#### 条件タブ
- ☐ **「コンピューターをAC電源で使用している場合のみタスクを開始する」** (チェックを外す)
- ☐ **「コンピューターがアイドル状態の場合のみタスクを開始する」** (チェックを外す)

#### 設定タブ
- ☑️ **「タスクを要求時に実行できるようにする」**
- ☑️ **「スケジュールされた開始時刻にタスクが開始されなかった場合、すぐにタスクを実行する」**
- **「タスクが失敗した場合の再起動の間隔」**: `1分`
- **「再起動を試行する回数」**: `3回`

## 🎯 推奨設定パターン

### パターン1: 常駐監視（推奨）
```
タスク名: Ferry Data Daemon
実行ファイル: auto_data_collection_daemon.bat
トリガー: コンピューター起動時
実行間隔: 常駐（30分間隔で自動収集）
```

### パターン2: 定期実行
```
タスク名: Ferry Data Collection
実行ファイル: auto_data_collection.bat  
トリガー: 毎日 00:00
実行間隔: 30分ごとに繰り返し
```

## 🧪 テスト実行

### 手動テスト
1. タスクスケジューラーでタスクを右クリック
2. **「実行」** を選択
3. タスクの状態が **「実行中」** になることを確認

### ログ確認
以下のファイルでログを確認：
- `auto_collection.log` - 単発実行ログ
- `daemon_collection.log` - 常駐実行ログ
- `ferry_monitoring.log` - システム詳細ログ

## 🔍 トラブルシューティング

### よくある問題と解決方法

#### 1. タスクが実行されない
**原因**: 権限不足
**解決**: 「最上位の特権で実行する」にチェック

#### 2. Pythonが見つからない
**原因**: PATH設定の問題
**解決**: バッチファイル内でPythonのフルパスを指定
```bat
"C:\Users\ichry\AppData\Local\Programs\Python\Python313\python.exe" ferry_monitoring_system.py
```

#### 3. パッケージが見つからない
**原因**: 必要なライブラリ未インストール
**解決**: バッチファイルで自動インストール（既に含まれています）

#### 4. データが更新されない
**原因**: 
- ネットワーク接続の問題
- ウェブサイトの変更
- 500件制限に到達

**確認方法**:
```cmd
cd C:\Users\ichry\OneDrive\Desktop\hokkaido_ferry_forecast
python -c "
import pandas as pd
df = pd.read_csv('data/ferry_cancellation_log.csv')
print(f'Current data count: {len(df)}')
print(f'Latest entry: {df.iloc[-1][\"timestamp\"]}')
"
```

## 📊 監視とメンテナンス

### 定期確認項目
1. **データ更新確認** - 毎日最新データが追加されているか
2. **ログファイル確認** - エラーが発生していないか  
3. **ディスク容量確認** - ログファイルが大きくなりすぎていないか

### メンテナンス作業
- **月1回**: ログファイルのローテーション
- **週1回**: データ蓄積状況の確認
- **随時**: システムエラー対応

## 🚀 高度な設定

### 複数タスクの設定
データ収集の冗長化のため、以下の複数タスクを設定することも可能：

1. **メインタスク**: 30分間隔の常駐監視
2. **バックアップタスク**: 1時間間隔の定期実行
3. **リカバリタスク**: 起動時の単発実行

### 通知設定
Discord/LINE通知システムが設定されている場合、エラー発生時に自動通知されます。

## ✅ 設定完了チェックリスト

- [ ] タスクスケジューラーでタスクが作成されている
- [ ] 手動実行でタスクが正常に動作する
- [ ] ログファイルが生成される
- [ ] データファイルが更新される
- [ ] 次回起動時に自動実行される

---

**📞 サポート**: 設定でお困りの場合は、ログファイルの内容を確認してトラブルシューティングを行ってください。